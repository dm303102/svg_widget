<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SVG Preview Widget</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .controls { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
    .controls label { flex: 1 1 120px; white-space: nowrap; }
    canvas { display: block; margin-top: 1em; border: 1px solid #ccc; }
    #svgList { list-style: none; padding: 0; margin-top: 1em; max-width: 400px; }
    #svgList li { display: flex; align-items: center; justify-content: space-between; padding: 0.3em; border-bottom: 1px solid #eee; }
    #svgList li.selected { background: #def; }
    .item-controls { display: flex; gap: 0.5em; }
    .filename { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    input[type=range] { width: 80px; }
  </style>
</head>
<body>
  <h1>Upload &amp; Preview Your SVGs</h1>
  <div class="controls">
    <label>Length:
      <select id="lengthSelect"><option value="">–</option></select>
    </label>
    <label>Width:
      <select id="widthSelect" disabled><option value="">–</option></select>
    </label>
    <span id="priceDisplay"></span>
    <button id="renderBtn">Render Canvas</button>
    <button id="toggleOrientation">Switch to Landscape</button>
    <button id="undoBtn">Undo</button>
    <button id="exportBtn">Export (SVG)</button>
  </div>
  <div id="fileInputContainer" style="display:none; margin-top:1em;">
    <input type="file" id="fileInput" accept=".svg" multiple>
  </div>
  <ul id="svgList"></ul>
  <canvas id="mainCanvas"></canvas>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const variants = [
      { length: 4, width: 4, price: 12.00 },
      { length: 4, width: 6, price: 14.00 },
      { length: 4, width: 8, price: 16.00 },
      { length: 4, width: 10, price: 18.00 },
      { length: 4, width: 12, price: 20.00 },
      { length: 6, width: 4, price: 14.00 },
      { length: 6, width: 6, price: 15.00 },
      { length: 6, width: 8, price: 17.00 },
      { length: 6, width: 10, price: 19.00 },
      { length: 6, width: 12, price: 21.00 },
      { length: 8, width: 4, price: 16.00 },
      { length: 8, width: 6, price: 17.00 },
      { length: 8, width: 8, price: 19.00 },
      { length: 8, width: 10, price: 21.00 },
      { length: 8, width: 12, price: 23.00 },
      { length: 10, width: 4, price: 18.00 },
      { length: 10, width: 6, price: 19.00 },
      { length: 10, width: 8, price: 21.00 },
      { length: 10, width: 10, price: 22.00 },
      { length: 10, width: 12, price: 24.00 },
      { length: 12, width: 4, price: 20.00 },
      { length: 12, width: 6, price: 21.00 },
      { length: 12, width: 8, price: 23.00 },
      { length: 12, width: 10, price: 24.00 },
      { length: 12, width: 12, price: 28.00 },
      { length: 14, width: 4, price: 22.00 },
      { length: 14, width: 6, price: 24.00 },
      { length: 14, width: 8, price: 26.00 },
      { length: 14, width: 10, price: 28.00 },
      { length: 14, width: 12, price: 30.00 },
      { length: 16, width: 4, price: 24.00 },
      { length: 16, width: 6, price: 25.00 },
      { length: 16, width: 8, price: 27.00 },
      { length: 16, width: 10, price: 29.00 },
      { length: 16, width: 12, price: 31.00 },
      { length: 18, width: 4, price: 26.00 },
      { length: 18, width: 6, price: 28.00 },
      { length: 18, width: 8, price: 30.00 },
      { length: 18, width: 10, price: 32.00 },
      { length: 18, width: 12, price: 34.00 },
      { length: 20, width: 4, price: 28.00 },
      { length: 20, width: 6, price: 30.00 },
      { length: 20, width: 8, price: 32.00 },
      { length: 20, width: 10, price: 34.00 },
      { length: 20, width: 12, price: 36.00 },
      { length: 22, width: 4, price: 30.00 },
      { length: 22, width: 6, price: 32.00 },
      { length: 22, width: 8, price: 34.00 },
      { length: 22, width: 10, price: 36.00 },
      { length: 22, width: 12, price: 38.00 },
      { length: 24, width: 4, price: 30.00 },
      { length: 24, width: 6, price: 32.00 },
      { length: 24, width: 8, price: 34.00 },
      { length: 24, width: 10, price: 36.00 },
      { length: 24, width: 12, price: 38.00 },
      { length: 26, width: 4, price: 32.00 },
      { length: 26, width: 6, price: 34.00 },
      { length: 26, width: 8, price: 36.00 },
      { length: 26, width: 10, price: 38.00 },
      { length: 26, width: 12, price: 40.00 },
      { length: 28, width: 4, price: 34.00 },
      { length: 28, width: 6, price: 36.00 },
      { length: 28, width: 8, price: 38.00 },
      { length: 28, width: 10, price: 40.00 },
      { length: 28, width: 12, price: 42.00 },
      { length: 30, width: 4, price: 36.00 },
      { length: 30, width: 6, price: 38.00 },
      { length: 30, width: 8, price: 40.00 },
      { length: 30, width: 10, price: 42.00 },
      { length: 30, width: 12, price: 44.00 },
      { length: 32, width: 4, price: 38.00 },
      { length: 32, width: 6, price: 40.00 },
      { length: 32, width: 8, price: 42.00 },
      { length: 32, width: 10, price: 44.00 },
      { length: 32, width: 12, price: 46.00 },
      { length: 34, width: 4, price: 40.00 },
      { length: 34, width: 6, price: 42.00 },
      { length: 34, width: 8, price: 44.00 },
      { length: 34, width: 10, price: 46.00 },
      { length: 34, width: 12, price: 48.00 },
      { length: 36, width: 4, price: 42.00 },
      { length: 36, width: 6, price: 44.00 },
      { length: 36, width: 8, price: 46.00 },
      { length: 36, width: 10, price: 48.00 },
      { length: 36, width: 12, price: 50.00 }
    ];
    
    const lengthSelect = document.getElementById('lengthSelect');
    const widthSelect  = document.getElementById('widthSelect');
    const priceDisplay = document.getElementById('priceDisplay');
    const fileInputContainer = document.getElementById('fileInputContainer');
    const renderBtn    = document.getElementById('renderBtn');
    const toggleBtn    = document.getElementById('toggleOrientation');
    const undoBtn      = document.getElementById('undoBtn');
    const exportBtn    = document.getElementById('exportBtn');
    const svgList      = document.getElementById('svgList');
    const fileInput    = document.getElementById('fileInput');
    const canvas       = document.getElementById('mainCanvas');
    const ctx          = canvas.getContext('2d');
    const DPI = 96, borderPx = 4;

    let images = [], selectedId = null, history = [];
    let dragging = false, cropping = false, cropStart = {}, dragOffset = {};

    function pushHistory(){
      history.push(JSON.parse(JSON.stringify(images)));
      if(history.length>50) history.shift();
    }
    
    undoBtn.addEventListener('click', () => {
      if (!history.length) return;
      images = history.pop();
      selectedId = images[0]?.id || null;
      updateList();
      redrawCanvas();
    });

    // --- selectors ---
    function initLength() {
      const valid = variants.filter(v=>v.price!=null);
      const lengths = Array.from(new Set(valid.map(v=>v.length))).sort((a,b)=>a-b);
      lengthSelect.innerHTML = '<option value="">–</option>';
      lengths.forEach(l=>{
        const opt = document.createElement('option');
        opt.value = l; opt.textContent = `${l}"`;
        lengthSelect.append(opt);
      });
      lengthSelect.disabled = false;
    }
    function onLengthChange() {
      const L = +lengthSelect.value;
      widthSelect.innerHTML = '<option value="">–</option>';
      widthSelect.disabled = !L;
      if (L) {
        const widths = variants.filter(v=>v.length===L && v.price!=null)
                               .map(v=>v.width)
                               .sort((a,b)=>a-b);
        widths.forEach(w=>{
          const opt = document.createElement('option');
          opt.value = w; opt.textContent = `${w}"`;
          widthSelect.append(opt);
        });
      }
      priceDisplay.textContent = '';
      fileInputContainer.style.display = 'none';
        redrawCanvas();
    }
    function onWidthChange() {
      const L = +lengthSelect.value, W = +widthSelect.value;
      const v = variants.find(v=>v.length===L && v.width===W && v.price!=null);
      priceDisplay.textContent = v ? `Price: $${v.price.toFixed(2)}` : '';
      fileInputContainer.style.display = v ? 'block' : 'none';
        redrawCanvas();
    }
       
    // --- redraw ---
    function redrawCanvas() {
      const L = +lengthSelect.value, W = +widthSelect.value;
      if (!(L && W)) { fileInputContainer.style.display='none'; return; }
      const wPx = L*DPI, hPx = W*DPI;
      canvas.width = wPx + 2*borderPx;
      canvas.height= hPx + 2*borderPx;

      // background
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.lineWidth=borderPx; ctx.strokeStyle='#000';
      ctx.strokeRect(borderPx/2,borderPx/2,wPx+borderPx,hPx+borderPx);

      // labels
      ctx.fillStyle='#000'; ctx.font='16px sans-serif';
      ctx.textAlign='left';  ctx.fillText(`L: ${L}"`, borderPx+4, canvas.height-4);
      ctx.textAlign='right'; ctx.fillText(`W: ${W}"`, canvas.width-borderPx-4, canvas.height-4);

      // draw images
      images.forEach(it=>{
        const dW = it.origW * it.fitScale * it.scalePercent;
        const dH = it.origH * it.fitScale * it.scalePercent;
        const cx = it.x + dW/2, cy = it.y + dH/2;
        ctx.save();
          ctx.translate(cx,cy);
          ctx.rotate(it.rotation||0);
          if (it.crop) {
            ctx.beginPath();
            ctx.rect(-dW/2+it.crop.x, -dH/2+it.crop.y, it.crop.w, it.crop.h);
            ctx.clip();
          }
          ctx.drawImage(it.image, -dW/2, -dH/2, dW, dH);
        ctx.restore();
        if (it.id === selectedId) {
          ctx.save();
            ctx.translate(cx,cy);
            ctx.rotate(it.rotation||0);
            ctx.strokeStyle='red'; ctx.lineWidth=2;
            ctx.strokeRect(-dW/2,-dH/2,dW,dH);
          ctx.restore();
        }
      });

      // active crop box
      if (cropping && cropStart.startX!=null) {
        const x0 = cropStart.startX, y0 = cropStart.startY;
        const w0 = cropStart.curX - x0, h0 = cropStart.curY - y0;
        ctx.save();
          ctx.strokeStyle='blue'; ctx.lineWidth=2; ctx.setLineDash([6,4]);
          ctx.strokeRect(x0,y0,w0,h0);
        ctx.restore();
      }
    }

    // --- list UI ---
    function updateList() {
      svgList.innerHTML = '';
      images.forEach((it,i) => {
        const li = document.createElement('li');
        li.dataset.id = it.id;
        if (it.id === selectedId) li.classList.add('selected');

        const name = document.createElement('span');
        name.className='filename';
        name.textContent = it.filename||`SVG ${i+1}`;

        const ctr = document.createElement('div');
        ctr.className='item-controls';

        // granular scale
        const sl = document.createElement('input');
        sl.type='range'; sl.min=10; sl.max=200; sl.step=0.1;
        sl.value = (it.scalePercent*100).toFixed(1);
        sl.dataset.id = it.id;

        const cropBtn = document.createElement('button');
        cropBtn.textContent='Crop'; cropBtn.dataset.id=it.id;

        const dupBtn = document.createElement('button');
        dupBtn.textContent='Duplicate'; dupBtn.dataset.id=it.id;

        const rotL = document.createElement('button');
        rotL.textContent='↺'; rotL.dataset.id=it.id;

        const rotR = document.createElement('button');
        rotR.textContent='↻'; rotR.dataset.id=it.id;

        const delBtn = document.createElement('button');
        delBtn.textContent='Delete'; delBtn.dataset.id=it.id;

        ctr.append(sl, cropBtn, dupBtn, rotL, rotR, delBtn);
        li.append(name, ctr);
        svgList.append(li);
      });
    }

    function selectImage(id) {
      selectedId = id;
      updateList();
      redrawCanvas();
    }

     // --- event wiring ---
    initLength();
    lengthSelect.addEventListener('change', onLengthChange);
    widthSelect .addEventListener('change', onWidthChange);
    
    svgList.addEventListener('click', e => {
      const li = e.target.closest('li');
      if (!li) return;
      const id = li.dataset.id;
      const it = images.find(img=>img.id===id);
      switch(e.target.textContent) {
        case 'Delete':
          pushHistory();
          images = images.filter(img=>img.id!==id);
          selectedId = images[0]?.id || null;
          updateList(); redrawCanvas();
          break;
        case 'Crop':
          selectImage(id);
          cropping = true;
          cropStart = { startX:null, startY:null, curX:null, curY:null };
          break;
        case 'Duplicate':
          pushHistory();
          const dup = {...it, id:Date.now()+'_'+Math.random(), x:it.x+10, y:it.y+10};
          images.push(dup);
          selectImage(dup.id);
          break;
        case '↺':
          pushHistory();
          it.rotation = (it.rotation||0) - Math.PI/180;
          selectImage(id);
          break;
        case '↻':
          pushHistory();
          it.rotation = (it.rotation||0) + Math.PI/180;
          selectImage(id);
          break;
        default:
          selectImage(id);
      }
    });

    svgList.addEventListener('input', e => {
      if (e.target.type!=='range') return;
      const it = images.find(img=>img.id===e.target.dataset.id);
      pushHistory();
      it.scalePercent = parseFloat(e.target.value)/100;
      selectImage(it.id);
    });

    // --- canvas events ---
    canvas.addEventListener('mousedown', e => {
      const r = canvas.getBoundingClientRect();
      const x = e.clientX - r.left, y = e.clientY - r.top;
      if (cropping) {
        cropStart.startX = x; cropStart.startY = y;
        cropStart.curX = x;   cropStart.curY = y;
        return;
      }
      // pick topmost
      for (let i=images.length-1; i>=0; i--) {
        const it = images[i];
        const dW = it.origW*it.fitScale*it.scalePercent;
        const dH = it.origH*it.fitScale*it.scalePercent;
        if (x>=it.x && x<=it.x+dW && y>=it.y && y<=it.y+dH) {
          selectImage(it.id);
          break;
        }
      }
      const sel = images.find(img=>img.id===selectedId);
      if (!sel) return;
      const dW = sel.origW*sel.fitScale*sel.scalePercent;
      const dH = sel.origH*sel.fitScale*sel.scalePercent;
      if (x>=sel.x && x<=sel.x+dW && y>=sel.y && y<=sel.y+dH) {
        dragging = true;
        dragOffset = { x: x - sel.x, y: y - sel.y };
      }
    });
    canvas.addEventListener('mousemove', e => {
      const r = canvas.getBoundingClientRect();
      const x = e.clientX - r.left, y = e.clientY - r.top;
      if (cropping && cropStart.startX!=null) {
        cropStart.curX = x; cropStart.curY = y;
        redrawCanvas();
        return;
      }
      if (dragging) {
        const sel = images.find(img=>img.id===selectedId);
        sel.x = x - dragOffset.x;
        sel.y = y - dragOffset.y;
        redrawCanvas();
      }
    });
    ['mouseup','mouseleave'].forEach(ev=>{
      canvas.addEventListener(ev, ()=>{
        if (cropping && cropStart.startX!=null) {
          pushHistory();
          const it = images.find(img=>img.id===selectedId);
          // compute crop relative
          const x0 = Math.min(cropStart.startX, cropStart.curX) - it.x;
          const y0 = Math.min(cropStart.startY, cropStart.curY) - it.y;
          const w0 = Math.abs(cropStart.curX - cropStart.startX);
          const h0 = Math.abs(cropStart.curY - cropStart.startY);
          // update SVG viewBox
          const doc = new DOMParser().parseFromString(it.svgText,'image/svg+xml');
          const svgEl = doc.documentElement;
          svgEl.setAttribute('viewBox', `${x0} ${y0} ${w0} ${h0}`);
          svgEl.removeAttribute('width');
          svgEl.removeAttribute('height');
          it.svgText = new XMLSerializer().serializeToString(svgEl);
          it.origW = w0; it.origH = h0;
          cropping = false;
        }
        dragging = false;
      });
    });

    renderBtn.addEventListener('click', redrawCanvas);

    toggleBtn.addEventListener('click', () => {
      // 1) stash the old values
      const oldL = lengthSelect.value;
      const oldW = widthSelect.value;
    
      // 2) swap them
      lengthSelect.value = oldW;
      lengthSelect.dispatchEvent(new Event('change'));

      widthSelect.value = oldL;
      widthSelect.dispatchEvent(new Event('change'));
    
      // 3) re‐draw everything
      //updateList();
      redrawCanvas();
    
      toggleBtn.textContent = toggleBtn.textContent.includes('Landscape')
        ? 'Switch to Portrait'
        : 'Switch to Landscape';
    });

    exportBtn.addEventListener('click', () => {
      const L = +lengthSelect.value, W = +widthSelect.value;
      if (!(L && W)) return;
      const wPx=L*DPI, hPx=W*DPI;
      const xmlns='http://www.w3.org/2000/svg';
      let out = `<?xml version="1.0" encoding="UTF-8"?><svg xmlns="${xmlns}" width="${wPx+borderPx*2}" height="${hPx+borderPx*2}" viewBox="0 0 ${wPx+borderPx*2} ${hPx+borderPx*2}">`;
      out += `<rect x="${borderPx/2}" y="${borderPx/2}" width="${wPx+borderPx}" height="${hPx+borderPx}" fill="none" stroke="black" stroke-width="${borderPx}"/>`;
      out += `<text x="${borderPx+4}" y="${hPx+borderPx*2-4}" font-size="16">L: ${L}"</text>`;
      out += `<text x="${wPx+borderPx*2-4}" y="${hPx+borderPx*2-4}" font-size="16" text-anchor="end">W: ${W}"</text>`;
      images.forEach(it=>{
        const dW=it.origW*it.fitScale*it.scalePercent, dH=it.origH*it.fitScale*it.scalePercent;
        out += `<svg x="${it.x}" y="${it.y}" width="${dW}" height="${dH}" viewBox="0 0 ${it.origW} ${it.origH}" xmlns="${xmlns}">`;
        out += new DOMParser().parseFromString(it.svgText,'image/svg+xml').documentElement.innerHTML;
        out += `</svg>`;
      });
      out += `</svg>`;
      const blob=new Blob([out],{type:'image/svg+xml'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='canvas-export.svg'; a.click();
      URL.revokeObjectURL(url);
    });

    // --- file load ---
    fileInput.addEventListener('change', e => {
      const L = +lengthSelect.value, W = +widthSelect.value;
      if (!(L && W)) return;
      const wPx = L*DPI, hPx = W*DPI;
      Array.from(e.target.files).forEach(file => {
        const r = new FileReader();
        r.onload = ev => {
          const txt = ev.target.result;
          const doc = new DOMParser().parseFromString(txt,'image/svg+xml');
          const svgEl = doc.documentElement;
          const origW = parseFloat(svgEl.getAttribute('width')) || parseFloat(svgEl.getAttribute('viewBox').split(' ')[2]);
          const origH = parseFloat(svgEl.getAttribute('height'))|| parseFloat(svgEl.getAttribute('viewBox').split(' ')[3]);
          const fitScale = Math.min(wPx/origW, hPx/origH);
          const dW = origW*fitScale, dH = origH*fitScale;
          const x = borderPx + (wPx-dW)/2, y = borderPx + (hPx-dH)/2;
          const id = Date.now()+'_'+Math.random();
          const img = new Image();
          img.onload = ()=> {
            images.push({ id, filename: file.name, svgText: txt, image: img,
                          origW, origH, fitScale, scalePercent:1, rotation:0, x, y });
            selectImage(id);
          };
          img.src = URL.createObjectURL(new Blob([txt],{type:'image/svg+xml'}));
        };
        r.readAsText(file);
      });
      fileInput.value = ''; // allow re-upload
    });

  });  
  </script>
</body>
</html>

