<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SVG Preview Widget</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .controls { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
    .controls label { flex: 1 1 120px; white-space: nowrap; }
    canvas { display: block; margin-top: 1em; border: 1px solid #ccc; }
    #svgList { list-style: none; padding: 0; margin-top: 1em; max-width: 400px; }
    #svgList li { display: flex; align-items: center; justify-content: space-between; padding: 0.3em; border-bottom: 1px solid #eee; cursor: pointer; }
    #svgList li.selected { background: #def; }
    #svgList li:hover { background: #f0f8ff; }
    #svgList .filename { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 0.5em; }
    #svgList .item-controls { display: flex; align-items: center; gap: 0.5em; }
    #svgList input[type="range"] { width: 80px; }
  </style>
</head>
<body>
  <h1>Upload &amp; Preview Your SVGs</h1>

  <div class="controls">
    <label>
      Length:
      <select id="lengthSelect"><option value="">–</option></select>
    </label>
    <label>
      Width:
      <select id="widthSelect" disabled><option value="">–</option></select>
    </label>
    <span id="priceDisplay"></span>
    <button id="renderBtn">Render Canvas</button>
    <button id="toggleOrientation">Switch to Landscape</button>
    <button id="exportBtn">Export (SVG)</button>
  </div>

  <div id="fileInputContainer" style="display:none; margin-top:1em;">
    <input type="file" id="fileInput" accept=".svg" multiple>
  </div>

  <ul id="svgList"></ul>
  <canvas id="mainCanvas"></canvas>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Full Etsy variants list (85 entries)
    const variants = [
      { length: 4, width: 4, price: 12.00 },
      { length: 4, width: 6, price: 14.00 },
      { length: 4, width: 8, price: 16.00 },
      { length: 4, width: 10, price: 18.00 },
      { length: 4, width: 12, price: 20.00 },
      { length: 6, width: 4, price: null },
      { length: 6, width: 6, price: 15.00 },
      { length: 6, width: 8, price: 17.00 },
      { length: 6, width: 10, price: 19.00 },
      { length: 6, width: 12, price: 21.00 },
      { length: 8, width: 4, price: null },
      { length: 8, width: 6, price: null },
      { length: 8, width: 8, price: 19.00 },
      { length: 8, width: 10, price: 21.00 },
      { length: 8, width: 12, price: 23.00 },
      { length: 10, width: 4, price: null },
      { length: 10, width: 6, price: null },
      { length: 10, width: 8, price: null },
      { length: 10, width: 10, price: 22.00 },
      { length: 10, width: 12, price: 24.00 },
      { length: 12, width: 4, price: null },
      { length: 12, width: 6, price: null },
      { length: 12, width: 8, price: null },
      { length: 12, width: 10, price: null },
      { length: 12, width: 12, price: 28.00 },
      { length: 14, width: 4, price: 22.00 },
      { length: 14, width: 6, price: 24.00 },
      { length: 14, width: 8, price: 26.00 },
      { length: 14, width: 10, price: 28.00 },
      { length: 14, width: 12, price: 30.00 },
      { length: 16, width: 4, price: 24.00 },
      { length: 16, width: 6, price: 25.00 },
      { length: 16, width: 8, price: 27.00 },
      { length: 16, width: 10, price: 29.00 },
      { length: 16, width: 12, price: 31.00 },
      { length: 18, width: 4, price: 26.00 },
      { length: 18, width: 6, price: 28.00 },
      { length: 18, width: 8, price: 30.00 },
      { length: 18, width: 10, price: 32.00 },
      { length: 18, width: 12, price: 34.00 },
      { length: 20, width: 4, price: 28.00 },
      { length: 20, width: 6, price: 30.00 },
      { length: 20, width: 8, price: 32.00 },
      { length: 20, width: 10, price: 34.00 },
      { length: 20, width: 12, price: 36.00 },
      { length: 22, width: 4, price: 30.00 },
      { length: 22, width: 6, price: 32.00 },
      { length: 22, width: 8, price: 34.00 },
      { length: 22, width: 10, price: 36.00 },
      { length: 22, width: 12, price: 38.00 },
      { length: 24, width: 4, price: 30.00 },
      { length: 24, width: 6, price: 32.00 },
      { length: 24, width: 8, price: 34.00 },
      { length: 24, width: 10, price: 36.00 },
      { length: 24, width: 12, price: 38.00 },
      { length: 26, width: 4, price: 32.00 },
      { length: 26, width: 6, price: 34.00 },
      { length: 26, width: 8, price: 36.00 },
      { length: 26, width: 10, price: 38.00 },
      { length: 26, width: 12, price: 40.00 },
      { length: 28, width: 4, price: 34.00 },
      { length: 28, width: 6, price: 36.00 },
      { length: 28, width: 8, price: 38.00 },
      { length: 28, width: 10, price: 40.00 },
      { length: 28, width: 12, price: 42.00 },
      { length: 30, width: 4, price: 36.00 },
      { length: 30, width: 6, price: 38.00 },
      { length: 30, width: 8, price: 40.00 },
      { length: 30, width: 10, price: 42.00 },
      { length: 30, width: 12, price: 44.00 },
      { length: 32, width: 4, price: 38.00 },
      { length: 32, width: 6, price: 40.00 },
      { length: 32, width: 8, price: 42.00 },
      { length: 32, width: 10, price: 44.00 },
      { length: 32, width: 12, price: 46.00 },
      { length: 34, width: 4, price: 40.00 },
      { length: 34, width: 6, price: 42.00 },
      { length: 34, width: 8, price: 44.00 },
      { length: 34, width: 10, price: 46.00 },
      { length: 34, width: 12, price: 48.00 },
      { length: 36, width: 4, price: 42.00 },
      { length: 36, width: 6, price: 44.00 },
      { length: 36, width: 8, price: 46.00 },
      { length: 36, width: 10, price: 48.00 },
      { length: 36, width: 12, price: 50.00 }
    ];
    
        // DOM elements
    const lenSel = document.getElementById('lengthSelect');
    const widSel = document.getElementById('widthSelect');
    const priceDisplay = document.getElementById('priceDisplay');
    const renderBtn = document.getElementById('renderBtn');
    const toggleBtn = document.getElementById('toggleOrientation');
    const exportBtn = document.getElementById('exportBtn');
    const fileInputContainer = document.getElementById('fileInputContainer');
    const fileInput = document.getElementById('fileInput');
    const svgList = document.getElementById('svgList');
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');

    let images = [];
    let selectedId = null;
    let dragging = false;
    let dragOffset = { x: 0, y: 0 };
    let handleCenter = { x: 0, y: 0 };
    const DPI = 96, borderPx = 4;

    // Populate Length selector with only valid price variants
    function initSelectors() {
      // Unique lengths and widths with price
      const lengths = [...new Set(variants.filter(v => v.price != null).map(v => v.length))].sort((a,b)=>a-b);
      const widths = [...new Set(variants.filter(v => v.price != null).map(v => v.width))].sort((a,b)=>a-b);

      lenSel.innerHTML = '<option value="">–</option>';
      const lengths = [...new Set(variants.filter(v=>v.price != null).map(v=>v.length))].sort((a,b)=>a-b);
      lengths.forEach(l=>{
        const opt = document.createElement('option');
        opt.value = l; opt.textContent = `${l}"`;
        lenSel.append(opt);
      });
      lenSel.disabled = false;
      lenSel.addEventListener('change', onLengthChange);
      widSel.addEventListener('change', updatePriceAndCanvas);
    }

    function onLengthChange() {
      widSel.innerHTML = '<option value="">–</option>';
      priceDisplay.textContent = '';
      const L = parseInt(lenSel.value, 10);
      if (!L) {
        widSel.disabled = true;
        return;
      }
      widSel.disabled = false;
      const widths = [...new Set(
        variants.filter(v=>v.length===L && v.price != null).map(v=>v.width)
      )].sort((a,b)=>a-b);
      widths.forEach(w=>{
        const opt = document.createElement('option');
        opt.value = w; opt.textContent = `${w}"`;
        widSel.append(opt);
      });
    }

    function updatePriceAndCanvas() {
      const L = parseInt(lenSel.value, 10), W = parseInt(widSel.value, 10);
      const variant = variants.find(v=>v.length===L && v.width===W && v.price != null);
      priceDisplay.textContent = variant ? `Price: $${variant.price.toFixed(2)}` : '';
      fileInputContainer.style.display = variant ? 'block' : 'none';
    }

    // Initial setup
    initSelectors();
    
    function redrawCanvas(){
      const L = parseInt(lenSel.value), W = parseInt(widSel.value);
      if(!(L && W)){ fileInputContainer.style.display='none'; return; }
      const wPx=L*DPI, hPx=W*DPI;
      canvas.width = wPx + borderPx*2;
      canvas.height = hPx + borderPx*2;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.lineWidth=borderPx; ctx.strokeStyle='#000';
      ctx.strokeRect(borderPx/2,borderPx/2,wPx+borderPx,hPx+borderPx);
      ctx.fillStyle='#000'; ctx.font='16px sans-serif';
      ctx.textAlign='left'; ctx.fillText(`L: ${L}"`,borderPx+4,canvas.height-4);
      ctx.textAlign='right';ctx.fillText(`W: ${W}"`,canvas.width-borderPx-4,canvas.height-4);
      images.forEach(item=>{
        const dW=item.origW*item.fitScale*item.scalePercent;
        const dH=item.origH*item.fitScale*item.scalePercent;
        ctx.drawImage(item.image,item.x,item.y,dW,dH);
      });
      if(selectedId){
        const itm=images.find(i=>i.id===selectedId);
        const dW=itm.origW*itm.fitScale*itm.scalePercent;
        const dH=itm.origH*itm.fitScale*itm.scalePercent;
        ctx.lineWidth=2;ctx.strokeStyle='red';ctx.strokeRect(itm.x,itm.y,dW,dH);
        handleCenter.x=itm.x + dW/2;
        handleCenter.y=itm.y - 12;
        ctx.beginPath();ctx.arc(handleCenter.x,handleCenter.y,6,0,2*Math.PI);
        ctx.fillStyle='#3498db';ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.stroke();
      }
    }

    function updateList(){
      svgList.innerHTML='';
      images.forEach((itm,i)=>{
        const li=document.createElement('li');li.dataset.id=itm.id;
        if(itm.id===selectedId)li.classList.add('selected');
        const ct=document.createElement('div');ct.className='item-controls';
        const sl=document.createElement('input');sl.type='range';sl.min=10;sl.max=200;
        sl.value=Math.round(itm.scalePercent*100);sl.dataset.id=itm.id;
        const del=document.createElement('button');del.textContent='Delete';del.dataset.id=itm.id;
        ct.append(sl,del);
        li.textContent=`SVG ${i+1}`;li.append(ct);
        svgList.append(li);
      });
    }

    function selectImage(id){ selectedId=id; updateList(); redrawCanvas(); }

    svgList.addEventListener('click',e=>{
      const id=e.target.dataset.id; if(!id)return;
      if(e.target.tagName==='BUTTON'){
        images.splice(images.findIndex(i=>i.id===id),1);
        selectedId = images[0]?.id || null;
        updateList(); redrawCanvas();
      }
    });

    svgList.addEventListener('input',e=>{
      if(e.target.type==='range'){
        const itm=images.find(i=>i.id===e.target.dataset.id);
        itm.scalePercent=e.target.value/100;
        selectImage(itm.id);
      }
    });

    renderBtn.addEventListener('click', redrawCanvas);

    toggleBtn.addEventListener('click',()=>{
      // swap selects
      const a=lenSel.value; lenSel.value=widSel.value; onLengthChange(); widSel.value=a; updatePriceAndCanvas();
      redrawCanvas();
      toggleBtn.textContent = toggleBtn.textContent.includes('Landscape')
        ? 'Switch to Portrait' : 'Switch to Landscape';
    });

    // Drag only via handle
    canvas.addEventListener('mousedown',e=>{
      if(!selectedId)return;
      const r=canvas.getBoundingClientRect();
      const x=e.clientX-r.left, y=e.clientY-r.top;
      const dx=x-handleCenter.x, dy=y-handleCenter.y;
      if(dx*dx+dy*dy<=36){
        dragging=true;
        const itm=images.find(i=>i.id===selectedId);
        dragOffset={x:x-itm.x,y:y-itm.y};
        canvas.style.cursor='grabbing';
      }
    });
    canvas.addEventListener('mousemove',e=>{
      if(dragging){
        const r=canvas.getBoundingClientRect();
        const x=e.clientX-r.left, y=e.clientY-r.top;
        const itm=images.find(i=>i.id===selectedId);
        itm.x=x-dragOffset.x; itm.y=y-dragOffset.y;
        redrawCanvas();
      }
    });
    ['mouseup','mouseleave'].forEach(ev=>canvas.addEventListener(ev,()=>{
      dragging=false; canvas.style.cursor='default';
    }));

    exportBtn.addEventListener('click',()=>{
      const L=parseInt(lenSel.value), W=parseInt(widSel.value);
      if(!(L&&W))return;
      const wPx=L*DPI, hPx=W*DPI;
      const xmlns='http://www.w3.org/2000/svg';
      let svg=`<?xml version="1.0" encoding="UTF-8"?><svg xmlns="${xmlns}" width="${wPx+borderPx*2}" height="${hPx+borderPx*2}" viewBox="0 0 ${wPx+borderPx*2} ${hPx+borderPx*2}">`;
      svg+=`<rect x="${borderPx/2}" y="${borderPx/2}" width="${wPx+borderPx}" height="${hPx+borderPx}" fill="none" stroke="black" stroke-width="${borderPx}"/>`;
      svg+=`<text x="${borderPx+4}" y="${hPx+borderPx*2-4}" font-family="sans-serif" font-size="16">L: ${L}"</text>`;
      svg+=`<text x="${wPx+borderPx*2-4}" y="${hPx+borderPx*2-4}" font-family="sans-serif" font-size="16" text-anchor="end">W: ${W}"</text>`;
      images.forEach(itm=>{
        const dW=itm.origW*itm.fitScale*itm.scalePercent;
        const dH=itm.origH*itm.fitScale*itm.scalePercent;
        const inner=new DOMParser().parseFromString(itm.svgText,'image/svg+xml').documentElement.innerHTML;
        svg+=`<svg x="${itm.x}" y="${itm.y}" width="${dW}" height="${dH}" viewBox="0 0 ${itm.origW} ${itm.origH}" xmlns="${xmlns}">${inner}</svg>`;
      });
      svg+='</svg>';
      const blob=new Blob([svg],{type:'image/svg+xml'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');a.href=url;a.download='canvas-export.svg';a.click();URL.revokeObjectURL(url);
    });

    fileInput.addEventListener('change',e=>{
      const files=Array.from(e.target.files);
      const L=parseInt(lenSel.value), W=parseInt(widSel.value);
      if(!(L&&W))return;
      const wPx=L*DPI, hPx=W*DPI;
      files.forEach(file=>{
        const r=new FileReader();
        r.onload=ev=>{
          const svgText=ev.target.result;
          const doc=new DOMParser().parseFromString(svgText,'image/svg+xml');
          const svgEl=doc.documentElement;
          const origW=parseFloat(svgEl.getAttribute('width'))||parseFloat(svgEl.getAttribute('viewBox').split(' ')[2]);
          const origH=parseFloat(svgEl.getAttribute('height'))||parseFloat(svgEl.getAttribute('viewBox').split(' ')[3]);
          const fitScale=Math.min(wPx/origW,hPx/origH);
          const drawW=origW*fitScale, drawH=origH*fitScale;
          const x=borderPx+(wPx-drawW)/2, y=borderPx+(hPx-drawH)/2;
          const id=Date.now()+'_'+Math.random();
          const blob=new Blob([svgText],{type:'image/svg+xml'});
          const url=URL.createObjectURL(blob);
          const img=new Image(); img.onload=()=>{
            URL.revokeObjectURL(url);
            images.push({id,svgText,image:img,origW,origH,fitScale,scalePercent:1,x,y});
            selectImage(id);
          };
          img.src=url;
        };
        r.readAsText(file);
      });
    });
  });
  </script>
</body>
</html>
