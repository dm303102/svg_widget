<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SVG Preview Widget</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .controls { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
    .controls label { flex: 1 1 120px; white-space: nowrap; }
    canvas { display: block; margin-top: 1em; border: 1px solid #ccc; }
    #svgList { list-style: none; padding: 0; margin-top: 1em; max-width: 400px; }
    #svgList li { display: flex; align-items: center; justify-content: space-between; padding: 0.3em; border-bottom: 1px solid #eee; }
    #svgList li.selected { background: #def; }
    .item-controls { display: flex; gap: 0.5em; }
    .filename { flex: 1 1 0; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    input[type=range] { width: 80px; }
  </style>
</head>
<body>
  <h1>Upload &amp; Preview Your SVGs</h1>
  <div class="controls">
    <label>Length:
      <select id="lengthSelect"><option value="">–</option></select>
    </label>
    <label>Width:
      <select id="widthSelect" disabled><option value="">–</option></select>
    </label>
    <span id="priceDisplay"></span>
    <button id="renderBtn">Render Canvas</button>
    <button id="undoBtn">Undo</button>
    <button id="exportBtn">Export (SVG)</button>
  </div>
  <div id="fileInputContainer" style="display:none; margin-top:1em;">
    <input type="file" id="fileInput" accept=".svg" multiple>
  </div>
  <ul id="svgList"></ul>
  <canvas id="mainCanvas"></canvas>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
    const variants = [
      { length: 4, width: 4, price: 12.00 },
      { length: 4, width: 6, price: 14.00 },
      { length: 4, width: 8, price: 16.00 },
      { length: 4, width: 10, price: 18.00 },
      { length: 4, width: 12, price: 20.00 },
      { length: 6, width: 4, price: 14.00 },
      { length: 6, width: 6, price: 15.00 },
      { length: 6, width: 8, price: 17.00 },
      { length: 6, width: 10, price: 19.00 },
      { length: 6, width: 12, price: 21.00 },
      { length: 8, width: 4, price: 16.00 },
      { length: 8, width: 6, price: 17.00 },
      { length: 8, width: 8, price: 19.00 },
      { length: 8, width: 10, price: 21.00 },
      { length: 8, width: 12, price: 23.00 },
      { length: 10, width: 4, price: 18.00 },
      { length: 10, width: 6, price: 19.00 },
      { length: 10, width: 8, price: 21.00 },
      { length: 10, width: 10, price: 22.00 },
      { length: 10, width: 12, price: 24.00 },
      { length: 12, width: 4, price: 20.00 },
      { length: 12, width: 6, price: 21.00 },
      { length: 12, width: 8, price: 23.00 },
      { length: 12, width: 10, price: 24.00 },
      { length: 12, width: 12, price: 28.00 },
      { length: 14, width: 4, price: 22.00 },
      { length: 14, width: 6, price: 24.00 },
      { length: 14, width: 8, price: 26.00 },
      { length: 14, width: 10, price: 28.00 },
      { length: 14, width: 12, price: 30.00 },
      { length: 16, width: 4, price: 24.00 },
      { length: 16, width: 6, price: 25.00 },
      { length: 16, width: 8, price: 27.00 },
      { length: 16, width: 10, price: 29.00 },
      { length: 16, width: 12, price: 31.00 },
      { length: 18, width: 4, price: 26.00 },
      { length: 18, width: 6, price: 28.00 },
      { length: 18, width: 8, price: 30.00 },
      { length: 18, width: 10, price: 32.00 },
      { length: 18, width: 12, price: 34.00 },
      { length: 20, width: 4, price: 28.00 },
      { length: 20, width: 6, price: 30.00 },
      { length: 20, width: 8, price: 32.00 },
      { length: 20, width: 10, price: 34.00 },
      { length: 20, width: 12, price: 36.00 },
      { length: 22, width: 4, price: 30.00 },
      { length: 22, width: 6, price: 32.00 },
      { length: 22, width: 8, price: 34.00 },
      { length: 22, width: 10, price: 36.00 },
      { length: 22, width: 12, price: 38.00 },
      { length: 24, width: 4, price: 30.00 },
      { length: 24, width: 6, price: 32.00 },
      { length: 24, width: 8, price: 34.00 },
      { length: 24, width: 10, price: 36.00 },
      { length: 24, width: 12, price: 38.00 },
      { length: 26, width: 4, price: 32.00 },
      { length: 26, width: 6, price: 34.00 },
      { length: 26, width: 8, price: 36.00 },
      { length: 26, width: 10, price: 38.00 },
      { length: 26, width: 12, price: 40.00 },
      { length: 28, width: 4, price: 34.00 },
      { length: 28, width: 6, price: 36.00 },
      { length: 28, width: 8, price: 38.00 },
      { length: 28, width: 10, price: 40.00 },
      { length: 28, width: 12, price: 42.00 },
      { length: 30, width: 4, price: 36.00 },
      { length: 30, width: 6, price: 38.00 },
      { length: 30, width: 8, price: 40.00 },
      { length: 30, width: 10, price: 42.00 },
      { length: 30, width: 12, price: 44.00 },
      { length: 32, width: 4, price: 38.00 },
      { length: 32, width: 6, price: 40.00 },
      { length: 32, width: 8, price: 42.00 },
      { length: 32, width: 10, price: 44.00 },
      { length: 32, width: 12, price: 46.00 },
      { length: 34, width: 4, price: 40.00 },
      { length: 34, width: 6, price: 42.00 },
      { length: 34, width: 8, price: 44.00 },
      { length: 34, width: 10, price: 46.00 },
      { length: 34, width: 12, price: 48.00 },
      { length: 36, width: 4, price: 42.00 },
      { length: 36, width: 6, price: 44.00 },
      { length: 36, width: 8, price: 46.00 },
      { length: 36, width: 10, price: 48.00 },
      { length: 36, width: 12, price: 50.00 }
    ];
    
    const DPI = 96, borderPx = 4;
    const lengthSelect = document.getElementById('lengthSelect');
    const widthSelect = document.getElementById('widthSelect');
    const priceDisplay = document.getElementById('priceDisplay');
    const fileInputContainer = document.getElementById('fileInputContainer');
    const renderBtn = document.getElementById('renderBtn');
    const undoBtn = document.getElementById('undoBtn');
    const exportBtn = document.getElementById('exportBtn');
    const svgList = document.getElementById('svgList');
    const fileInput = document.getElementById('fileInput');
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    
    let images = [], selectedId = null, history = [];
    let dragging = false, cropping = false, dragOffset = { x: 0, y: 0 },
      cropStart  = { startX: 0, startY: 0, curX: 0, curY: 0 };
      
function initLength() {
  const lengths = Array.from(new Set(variants.map(v => v.length))).sort((a,b)=>a-b);
  lengthSelect.innerHTML = '<option value="">–</option>';
  lengths.forEach(l => {
    const opt = document.createElement('option');
    opt.value = l;
    opt.textContent = `${l}"`;
    lengthSelect.appendChild(opt);
  });
  lengthSelect.disabled = false;
}

function onLengthChange() {
  const L = +lengthSelect.value;
  widthSelect.innerHTML = '<option value="">–</option>';
  widthSelect.disabled = !L;
  if (L) {
    const widths = variants
      .filter(v => v.length === L)
      .map(v => v.width)
      .sort((a,b)=>a-b);
    widths.forEach(w => {
      const opt = document.createElement('option');
      opt.value = w;
      opt.textContent = `${w}"`;
      widthSelect.appendChild(opt);
    });
  }
  priceDisplay.textContent = '';
  fileInputContainer.style.display = 'none';
  redrawCanvas();
}

    function onWidthChange() {
      const L = +lengthSelect.value;
      const W = +widthSelect.value;
      const v = variants.find(x=>x.length===L&&x.width===W);
      priceDisplay.textContent = v ? `Price: $${v.price.toFixed(2)}` : '';
      fileInputContainer.style.display = v ? 'block' : 'none';
      redrawCanvas();
    }

    initLength();
      
    function pushHistory() {
      history.push(images.map(item => ({ ...item })));
      if (history.length > 50) history.shift();
    }

    function redrawCanvas() {
      const L = +lengthSelect.value, W = +widthSelect.value;
      if (L && W) {
        const wPx = L * DPI, hPx = W * DPI;
        canvas.width = wPx + 2*borderPx;
        canvas.height = hPx + 2*borderPx;
        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.lineWidth = borderPx; ctx.strokeStyle = '#000';
        ctx.strokeRect(borderPx/2, borderPx/2, wPx+borderPx, hPx+borderPx);
        ctx.fillStyle = '#000'; ctx.font = '16px sans-serif';
        ctx.textAlign = 'left'; ctx.fillText(`L: ${L}"`, borderPx+4, canvas.height-4);
        ctx.textAlign = 'right'; ctx.fillText(`W: ${W}"`, canvas.width-borderPx-4, canvas.height-4);
      }
      images.forEach(it => {
        const dW = it.origW * it.fitScale * it.scalePercent;
        const dH = it.origH * it.fitScale * it.scalePercent;
        const cx = it.x + dW/2, cy = it.y + dH/2;
        ctx.save(); ctx.translate(cx,cy); ctx.rotate(it.rotation);
        ctx.drawImage(it.image, -dW/2, -dH/2, dW, dH); ctx.restore();
        if (it.id === selectedId) {
          ctx.save(); ctx.translate(cx,cy); ctx.rotate(it.rotation);
          ctx.strokeStyle='red'; ctx.lineWidth=2;
          ctx.strokeRect(-dW/2, -dH/2, dW, dH);
          ctx.restore();
        }
      });
    }

        function updateList() {
      svgList.innerHTML = '';
      images.forEach((it,i) => {
        const li = document.createElement('li'); li.dataset.id = it.id;
        if (it.id===selectedId) li.classList.add('selected');
        const name = document.createElement('span'); name.className='filename';
        name.textContent = it.filename;
        const ctr = document.createElement('div'); ctr.className='item-controls';
        // add buttons/range here...
        li.append(name, ctr); svgList.append(li);
      });
    }

    function selectImage(id) {
      selectedId = id; updateList(); redrawCanvas();
    }

    function handleFileLoad(e) {
      const L = +lengthSelect.value, W = +widthSelect.value;
      if (!(L&&W)) return;
      const wPx = L*DPI, hPx = W*DPI;
      Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = ev => {
          const txt = ev.target.result;
          const doc = new DOMParser().parseFromString(txt,'image/svg+xml');
          const svgEl = doc.documentElement;
          const origW = parseFloat(svgEl.getAttribute('width')) || parseFloat(svgEl.getAttribute('viewBox').split(' ')[2]);
          const origH = parseFloat(svgEl.getAttribute('height'))|| parseFloat(svgEl.getAttribute('viewBox').split(' ')[3]);
          const fitScale = Math.min(wPx/origW, hPx/origH);
          const dW = origW*fitScale, dH = origH*fitScale;
          const x = borderPx+(wPx-dW)/2, y = borderPx+(hPx-dH)/2;
          const id = Date.now()+'_'+Math.random();
          const img = new Image();
          img.onload = ()=>{
            images.push({ id, filename:file.name, image:img, svgText:txt, origW, origH, fitScale,
                          scalePercent:1, rotation:0, x, y});
            pushHistory(); selectImage(id);
          };
          img.src = URL.createObjectURL(new Blob([txt],{type:'image/svg+xml'}));
        };
        reader.readAsText(file);
      });
    }

    function exportSVG() {
      const L = +lengthSelect.value, W = +widthSelect.value;
      if (!(L&&W)) return;
      const wPx=L*DPI, hPx=W*DPI;
      const xmlns='http://www.w3.org/2000/svg';
      let out = `<svg xmlns="${xmlns}" width="${wPx+2*borderPx}" height="${hPx+2*borderPx}" viewBox="0 0 ${wPx+2*borderPx} ${hPx+2*borderPx}">`;
      out += `<rect x="${borderPx/2}" y="${borderPx/2}" width="${wPx+borderPx}" height="${hPx+borderPx}" fill="none" stroke="black" stroke-width="${borderPx}"/>`;
      images.forEach(it=>{
        const dW=it.origW*it.fitScale*it.scalePercent;
        const dH=it.origH*it.fitScale*it.scalePercent;
        out += `<svg x="${it.x}" y="${it.y}" width="${dW}" height="${dH}" viewBox="0 0 ${it.origW} ${it.origH}" xmlns="${xmlns}">`;
        out += new DOMParser().parseFromString(it.svgText,'image/svg+xml').documentElement.innerHTML;
        out += `</svg>`;
      });
      out += `</svg>`;
      const blob = new Blob([out],{type:'image/svg+xml'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='canvas-export.svg'; a.click(); URL.revokeObjectURL(url);
    }

      // wire events    
    renderBtn.addEventListener('click', redrawCanvas);
    exportBtn.addEventListener('click', exportSVG);
    fileInput.addEventListener('change', handleFileLoad);
    undoBtn.addEventListener('click', () => { if(!history.length) return; images = history.pop(); selectImage(images[0]?.id); });
    lengthSelect.addEventListener('change', onLengthChange);
    widthSelect.addEventListener('change', onWidthChange);
    svgList.addEventListener('click', e => { /* handle select/dup/rotate/delete/crop */ });

    // canvas dragging & cropping
// 1) MOUSE DOWN
canvas.addEventListener('mousedown', e => {
  const { x, y } = toCanvasCoords(e);

  if (cropping) {
    // Begin crop rectangle
    cropStart.startX = cropStart.curX = x;
    cropStart.startY = cropStart.curY = y;
    return;
  }

  // See if click lands inside the currently selected image:
  const sel = images.find(img => img.id === selectedId);
  if (sel && hitTest(sel, x, y)) {
    // prepare to drag
    dragging = true;
    // record offset from img origin so it doesn’t “jump”
    dragOffset.x = x - sel.x;
    dragOffset.y = y - sel.y;
    pushHistory();  // snapshot before move
  }
});

// 2) MOUSE MOVE
canvas.addEventListener('mousemove', e => {
  const { x, y } = toCanvasCoords(e);

  if (cropping && cropStart.startX != null) {
    // update crop rectangle
    cropStart.curX = x;
    cropStart.curY = y;
    redrawCanvas();       // draw existing images...
    drawCropOverlay();    // ...then draw the semi‑transparent box
    return;
  }

  if (dragging) {
    // move the selected image
    const sel = images.find(img => img.id === selectedId);
    sel.x = x - dragOffset.x;
    sel.y = y - dragOffset.y;
    redrawCanvas();
  }
});

// 3) MOUSE UP / LEAVE
['mouseup','mouseleave'].forEach(evt =>
  canvas.addEventListener(evt, () => {
    if (cropping && cropStart.startX != null) {
      finalizeCrop();
    }
    if (dragging) {
      // done moving: refresh list highlight & canvas
      updateList();
      redrawCanvas();
    }
    // reset flags
    dragging = cropping = false;
  })
);

// ————————————————————————————————————————————————
// helper functions:

function toCanvasCoords(e) {
  const r = canvas.getBoundingClientRect();
  return { x: e.clientX - r.left, y: e.clientY - r.top };
}

function hitTest(img, x, y) {
  // simple AABB test (ignores rotation for brevity)
  const w = img.origW * img.fitScale * img.scalePercent;
  const h = img.origH * img.fitScale * img.scalePercent;
  return x >= img.x && x <= img.x + w && y >= img.y && y <= img.y + h;
}

function drawCropOverlay() {
  const { startX, startY, curX, curY } = cropStart;
  const x0 = Math.min(startX, curX), y0 = Math.min(startY, curY);
  const w0 = Math.abs(curX - startX),  h0 = Math.abs(curY - startY);

  ctx.save();
    ctx.fillStyle = 'rgba(0,0,0,0.15)';
    ctx.fillRect(x0, y0, w0, h0);
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 2;
    ctx.strokeRect(x0, y0, w0, h0);
  ctx.restore();
}

function finalizeCrop() {
  const it = images.find(img => img.id === selectedId);
  const { startX, startY, curX, curY } = cropStart;
  const x0 = Math.min(startX, curX) - it.x;
  const y0 = Math.min(startY, curY) - it.y;
  const w0 = Math.abs(curX - startX);
  const h0 = Math.abs(curY - startY);

  pushHistory();  // snapshot before cropping

  // draw the selected region into a temp canvas
  const tmp = document.createElement('canvas');
  tmp.width = w0;  tmp.height = h0;
  const tctx = tmp.getContext('2d');
  tctx.drawImage(it.image, x0, y0, w0, h0, 0, 0, w0, h0);

  // replace image with the cropped one
  const newImg = new Image();
  newImg.onload = () => {
    it.image        = newImg;
    it.origW        = w0;
    it.origH        = h0;
    it.fitScale     = 1;
    it.scalePercent = 1;
    // re‑center in canvas
    it.x = borderPx + (canvas.width/2 - w0/2);
    it.y = borderPx + (canvas.height/2 - h0/2);

    updateList();
    redrawCanvas();
  };
  newImg.src = tmp.toDataURL();
}    
  </script>
</body>
</html>
